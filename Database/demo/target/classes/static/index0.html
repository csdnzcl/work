<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网上书店管理系统 - 首页</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .book-card { transition: transform 0.2s; cursor: pointer; }
        .book-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stock-badge { position: absolute; top: 10px; right: 10px; }
        .low-stock { background-color: #dc3545; color: white; }
        .search-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 0; color: white; }
    </style>
</head>
<body>

<div id="app">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-book-open me-2"></i>网上书店</a>
            <div class="d-flex align-items-center text-white">
                <div v-if="user.isLoggedIn" class="me-3">
                    <span class="me-3"><i class="fas fa-user-circle"></i> {{ user.name }}</span>
                    <span class="badge bg-warning text-dark me-2" title="信用等级">
                        LV.{{ user.creditLevel }} ({{ user.discount * 100 }}% 折扣)
                    </span>
                    <span class="badge bg-success me-3" title="账户余额">
                        余额: ¥{{ user.balance.toFixed(2) }}
                    </span>
                    <button class="btn btn-outline-light btn-sm" @click="showOrderHistory">
                        <i class="fas fa-history"></i> 我的订单
                    </button>
                </div>
                <button v-else class="btn btn-outline-light btn-sm" @click="openLoginModal">
                    登录 / 注册
                </button>
            </div>
        </div>
    </nav>

    <div class="search-section text-center">
        <div class="container">
            <h2 class="mb-4">探索知识的海洋</h2>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="input-group input-group-lg">
                        <select class="form-select" style="max-width: 120px;" v-model="searchType">
                            <option value="title">书名</option>
                            <option value="author">作者</option>
                            <option value="keyword">关键字</option>
                        </select>
                        <input type="text" class="form-control" v-model="searchQuery" placeholder="输入书名、ISBN或作者...">
                        <button class="btn btn-warning" type="button" @click="searchBooks">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row g-4">
            <div class="col-md-3 col-sm-6" v-for="book in filteredBooks" :key="book.isbn">
                <div class="card h-100 book-card">
                    <span v-if="book.stockQty < book.minStock" class="badge rounded-pill stock-badge low-stock">
                        库存紧张: {{ book.stockQty }}
                    </span>
                    <span v-else class="badge rounded-pill bg-success stock-badge">
                        库存: {{ book.stockQty }}
                    </span>

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">{{ book.title }}</h5>
                        <p class="card-text text-muted small mb-2">
                            <i class="fas fa-user-pen"></i> {{ book.authors }}
                        </p>
                        <p class="card-text text-secondary small mb-3">
                            <i class="fas fa-building"></i> {{ book.publisher }}
                        </p>
                        
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <div>
                                <span class="h5 text-danger fw-bold">¥{{ (book.price * user.discount).toFixed(2) }}</span>
                                <span class="text-decoration-line-through text-muted small ms-1">¥{{ book.price }}</span>
                            </div>
                            <button class="btn btn-primary btn-sm" @click="addToCart(book)" :disabled="book.stockQty <= 0">
                                <i class="fas fa-cart-plus"></i> 购买
                            </button>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0 text-muted small">
                        ISBN: {{ book.isbn }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单确认</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>正在购买: <strong>{{ currentBook.title }}</strong></p>
                    <div class="mb-3">
                        <label>数量:</label>
                        <input type="number" class="form-control" v-model.number="orderQuantity" min="1" :max="currentBook.stockQty">
                    </div>
                    <div class="alert alert-info">
                        总价: ¥{{ (currentBook.price * user.discount * orderQuantity).toFixed(2) }}
                        <br>
                        <small>当前信用等级 Lv.{{user.creditLevel}} 享受 {{user.discount*100}}% 折扣</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" @click="submitOrder">
                        确认支付 (调用存储过程)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-list-alt"></i> 历史订单</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div v-if="myOrders.length === 0" class="text-center text-muted py-4">
                        暂无订单记录
                    </div>
                    <div v-else class="list-group">
                        <div class="list-group-item" v-for="order in myOrders" :key="order.id">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    订单号: #{{ order.id }} 
                                    <small class="text-muted ms-2">{{ order.date }}</small>
                                </h6>
                                <span class="badge" :class="getOrderStatusClass(order.status)">
                                    {{ order.status }}
                                </span>
                            </div>
                            <p class="mb-1 text-secondary small">{{ order.summary }}</p>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">收货地址: {{ order.address }}</small>
                                <span class="fw-bold text-dark">总计: ¥{{ order.total.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
<!--第一个添加点-->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>用户名</label>
                        <input type="text" class="form-control" v-model="loginForm.username">
                    </div>
                    <div class="mb-3">
                        <label>密码</label>
                        <input type="password" class="form-control" v-model="loginForm.password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" @click="handleLogin">登录</button>
                </div>
            </div>
        </div>
    </div>


</div> <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                <!-- 第二个修改点-->
                user: { isLoggedIn: false, name: '', balance: 0 }, // 初始状态为空
                loginForm: { username: '', password: '' },
                loginModal: null,
                /*user: {
                    isLoggedIn: true,
                    name: "张三",
                    customerId: 1001,
                    creditLevel: 2,
                    discount: 0.95,
                    balance: 1500.00
                },*/
                searchType: 'title',
                searchQuery: '',
                books: [
                    {
                        isbn: '9787506365437',
                        title: '活着',
                        authors: '余华',
                        publisher: '作家出版社',
                        price: 35.00,
                        stockQty: 7,
                        minStock: 10
                    },
                    {
                        isbn: '9787111545682',
                        title: '深入理解计算机系统',
                        authors: 'Randal E.Bryant',
                        publisher: '机械工业出版社',
                        price: 139.00,
                        stockQty: 50,
                        minStock: 10
                    },
                    {
                        isbn: '9787302423287',
                        title: '数据结构(C++语言版)',
                        authors: '邓俊辉',
                        publisher: '清华大学出版社',
                        price: 58.00,
                        stockQty: 100,
                        minStock: 20
                    }
                ],
                // 购物车相关
                currentBook: {},
                orderQuantity: 1,
                cartModal: null,

                // 历史订单相关 (新增数据)
                orderHistoryModal: null,
                myOrders: [
                    { id: 2023001, date: '2025-12-10 14:20', status: 'Shipped', total: 70.00, summary: '活着 x 2', address: '学校南门' },
                    { id: 2023005, date: '2025-12-15 09:30', status: 'Pending', total: 139.00, summary: '深入理解计算机系统 x 1', address: '图书馆前台' }
                ]
            }
        },
        computed: {
            filteredBooks() {
                if (!this.searchQuery) return this.books;
                const query = this.searchQuery.toLowerCase();
                return this.books.filter(book => {
                    if (this.searchType === 'title') return book.title.toLowerCase().includes(query);
                    if (this.searchType === 'author') return book.authors.toLowerCase().includes(query);
                    return book.title.toLowerCase().includes(query);
                });
            }
        },
        mounted() {
            <!-- 第三个修改点-->
            this.loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            this.cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            this.orderHistoryModal = new bootstrap.Modal(document.getElementById('orderHistoryModal'));
            this.fetchBooks(); // 页面一加载就查书
            /*// 初始化两个 Modal
            this.cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            this.orderHistoryModal = new bootstrap.Modal(document.getElementById('orderHistoryModal'));*/
        },
        methods: {
            <!-- 第四个修改点-->
            openLoginModal() {
                this.loginModal.show();
            },
            handleLogin() {
                // 调用后端登录接口
                axios.post('http://localhost:8080/api/login', this.loginForm)
                    .then(res => {
                        if (res.data.success) {
                            const u = res.data.data;
                            this.user = {
                                isLoggedIn: true,
                                customerId: u.customerId,
                                name: u.name,
                                balance: u.balance,
                                creditLevel: u.creditLevel,
                                discount: 0.9 // 简化处理
                            };
                            this.loginModal.hide();
                            alert("登录成功！");
                        } else {
                            alert("登录失败: " + res.data.message);
                        }
                    });
            },

            // 新增：模拟登录并获取最新数据
            loginAsDefaultUser() {
                // 这里为了演示方便，直接写死用户名密码，或者直接调 getUserInfo
                // 实际操作：你可以先手动在数据库 T_CUSTOMERS 插一条记录: ID=1, Name=zhangsan, Password=123

                // 调用后端刷新数据
                axios.get('http://localhost:8080/api/user/1')
                    .then(res => {
                        if(res.data) {
                            const u = res.data;
                            this.user = {
                                isLoggedIn: true,
                                customerId: u.customerId,
                                name: u.name,
                                balance: u.balance,
                                creditLevel: u.creditLevel,
                                // 根据等级简单计算折扣 (和数据库规则对应)
                                discount: u.creditLevel === 1 ? 0.90 : (u.creditLevel === 5 ? 0.75 : 0.85)
                            };
                        }
                    });
            },



            searchBooks() {
                console.log(`Searching for ${this.searchQuery}`);
            },
            addToCart(book) {
                this.currentBook = book;
                this.orderQuantity = 1;
                this.cartModal.show();
            },

            submitOrder() {
                axios.post('http://localhost:8080/api/order/submit', {
                    customerId: this.user.customerId,
                    isbn: this.currentBook.isbn,
                    quantity: this.orderQuantity
                }).then(res => {
                    if (res.data.success) {
                        alert("支付成功！" + res.data.message);
                        this.cartModal.hide();
                        this.fetchBooks(); // 刷新库存
                        this.loginAsDefaultUser(); // !关键点：重新拉取用户信息，余额变动立马可见！
                    } else {
                        alert("支付失败: " + res.data.message);
                    }
                });
            },

            /*submitOrder() {
                alert(`模拟调用后端存储过程 SP_Process_Order_Payment\n用户ID: ${this.user.customerId}\nISBN: ${this.currentBook.isbn}\n数量: ${this.orderQuantity}`);
                this.cartModal.hide();
            },*/
            // 新增方法：显示历史订单
            showOrderHistory() {
                this.orderHistoryModal.show();
            },
            // 新增方法：获取状态颜色
            getOrderStatusClass(status) {
                if (status === 'Paid') return 'bg-success';
                if (status === 'Pending') return 'bg-warning text-dark';
                if (status === 'Shipped') return 'bg-primary';
                return 'bg-secondary';
            }
        }
    }).mount('#app');
</script>

</body>
</html>