<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网上书店 - 企业级后台管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar { background: #2c3e50; min-height: 100vh; color: #ecf0f1; }
        .nav-link { color: #bdc3c7; cursor: pointer; }
        .nav-link:hover { color: #fff; background: #3e5871; }
        .nav-link.active { background: #3498db; color: #fff; border-left: 4px solid #2980b9; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .text-price { color: #e74c3c; font-weight: bold; } /* 进价显示为红色 */
        .text-profit { color: #27ae60; font-weight: bold; } /* 利润显示为绿色 */
    </style>
</head>
<body>

<div id="adminApp" class="d-flex">
    <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 250px;">
        <h4 class="text-center mb-4"><i class="fas fa-database me-2"></i>后台管理中心</h4>
        <div class="user-panel mb-3 text-center pb-3 border-bottom border-secondary">
            <div class="bg-light rounded-circle mx-auto d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px; color: #333;">
                <i class="fas fa-user-shield fa-lg"></i>
            </div>
            <div class="small">当前用户: Administrator</div>
            <div class="badge bg-danger mt-1">权限: 最高等级 (子模式 B)</div>
        </div>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item mb-2">
                <a class="nav-link" :class="{active: currentTab === 'dashboard'}" @click="currentTab = 'dashboard'">
                    <i class="fas fa-chart-line me-2"></i> 财务概览
                </a>
            </li>
            <li class="nav-item mb-2">
                <a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'">
                    <i class="fas fa-boxes me-2"></i> 库存与成本 (核心)
                </a>
            </li>
            <li class="nav-item mb-2">
                <a class="nav-link" :class="{active: currentTab === 'procurement'}" @click="currentTab = 'procurement'">
                    <i class="fas fa-truck me-2"></i> 采购入库
                    <span v-if="shortages.length" class="badge bg-warning text-dark ms-auto float-end">{{shortages.length}}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" :class="{active: currentTab === 'orders'}" @click="currentTab = 'orders'">
                    <i class="fas fa-file-invoice-dollar me-2"></i> 订单管理
                </a>
            </li>
        </ul>
    </div>

    <div class="flex-grow-1 bg-light p-4 overflow-auto" style="height: 100vh;">
        
        <div v-if="currentTab === 'dashboard'">
            <h3 class="mb-4">财务经营数据</h3>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-stat p-3 bg-white">
                        <div class="text-muted small">今日销售额</div>
                        <div class="fs-4 fw-bold text-primary">¥{{ stats.dailySales }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-stat p-3 bg-white">
                        <div class="text-muted small">预计毛利 (售价-进价)</div>
                        <div class="fs-4 fw-bold text-success">¥{{ stats.dailyProfit }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-stat p-3 bg-white">
                        <div class="text-muted small">待处理缺货</div>
                        <div class="fs-4 fw-bold text-danger">{{ shortages.length }} 笔</div>
                    </div>
                </div>
            </div>
            <div class="card p-4 shadow-sm border-0">
                <h5>近7日收支结构分析</h5>
                <div class="progress mt-3" style="height: 30px;">
                    <div class="progress-bar bg-primary" style="width: 70%">销售收入 (70%)</div>
                    <div class="progress-bar bg-danger" style="width: 30%">采购成本 (30%)</div>
                </div>
                <p class="text-muted small mt-2"><i class="fas fa-info-circle"></i> 此数据仅对管理员可见 (Admin Sub-schema)。</p>
            </div>
        </div>

        <div v-if="currentTab === 'inventory'">
            <h3 class="mb-4">图书库存与成本核算</h3>
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between py-3">
                    <div class="input-group" style="max-width: 400px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="搜索ISBN或书名..." v-model="searchQuery">
                    </div>
                    <button class="btn btn-primary" @click="openNewBookModal">
                        <i class="fas fa-plus-circle me-1"></i> 新书录入
                    </button>
                </div>
                
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ISBN / 书名</th>
                            <th>供应商</th>
                            <th>进价 (Cost)</th> <th>售价 (Price)</th>
                            <th>单本利润</th>
                            <th>库存 / 警戒线</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="book in filteredBooks" :key="book.isbn">
                            <td>
                                <div class="fw-bold">{{ book.title }}</div>
                                <div class="text-muted small">{{ book.isbn }}</div>
                            </td>
                            <td>{{ book.supplier }}</td>
                            <td class="text-price">¥{{ book.costPrice.toFixed(2) }}</td>
                            <td>¥{{ book.price.toFixed(2) }}</td>
                            <td class="text-profit">+¥{{ (book.price - book.costPrice).toFixed(2) }}</td>
                            <td>
                                <span :class="book.stock < book.minStock ? 'text-danger fw-bold' : ''">
                                    {{ book.stock }} / {{ book.minStock }}
                                </span>
                            </td>
                            <td>
                                <span v-if="book.stock < book.minStock" class="badge bg-danger">缺货报警</span>
                                <span v-else class="badge bg-success">正常</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentTab === 'procurement'">
            <h3 class="mb-4">智能采购中心</h3>
            <div class="alert alert-info shadow-sm">
                <i class="fas fa-robot me-2"></i> 系统已根据数据库触发器 <strong>TR_Auto_Shortage_Reg</strong> 自动生成以下补货建议。
            </div>
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>缺货记录ID</th>
                                <th>图书信息</th>
                                <th>来源 (Source)</th>
                                <th>建议补货量</th>
                                <th>预计采购成本</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="s in shortages" :key="s.id">
                                <td>#{{ s.id }}</td>
                                <td>{{ s.bookName }}</td>
                                <td>
                                    <span class="badge" :class="s.source==='Auto'?'bg-primary':'bg-warning text-dark'">
                                        {{ s.source }}
                                    </span>
                                </td>
                                <td class="fw-bold fs-5">{{ s.qty }}</td>
                                <td>¥{{ (s.qty * s.costPerUnit).toFixed(2) }}</td>
                                <td>
                                    <button class="btn btn-success btn-sm" @click="handleRestock(s)">
                                        <i class="fas fa-check-circle me-1"></i> 确认进货
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="shortages.length === 0">
                                <td colspan="6" class="text-center py-4 text-muted">当前库存充足，无缺货记录。</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'orders'">
            <h3 class="mb-4">订单发货管理</h3>
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span>待处理订单列表</span>
                    <button class="btn btn-sm btn-outline-secondary" @click="refreshData"><i class="fas fa-sync"></i> 刷新</button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>订单号</th>
                                <th>客户名</th>
                                <th>下单时间</th>
                                <th>金额</th>
                                <th>当前状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in orders" :key="order.id">
                                <td>#{{ order.id }}</td>
                                <td>{{ order.customerName }}</td>
                                <td>{{ order.date }}</td>
                                <td class="fw-bold">¥{{ order.amount }}</td>
                                <td>
                                    <span class="badge" :class="getOrderStatusClass(order.status)">{{ order.status }}</span>
                                </td>
                                <td>
                                    <button v-if="order.status === 'Paid'" class="btn btn-sm btn-primary" @click="shipOrder(order)">
                                        <i class="fas fa-shipping-fast"></i> 发货
                                    </button>
                                    <button v-if="order.status === 'Pending'" class="btn btn-sm btn-secondary" disabled>
                                        等待付款
                                    </button>
                                    <span v-if="order.status === 'Shipped'" class="text-success"><i class="fas fa-check"></i> 已发货</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="newBookModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">录入新书 (Insert T_BOOKS)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" v-model="newBook.isbn" placeholder="978-...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">书名</label>
                            <input type="text" class="form-control" v-model="newBook.title">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">售价 (Price)</label>
                                <input type="number" class="form-control" v-model.number="newBook.price">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-danger">进价 (Cost - Admin)</label>
                                <input type="number" class="form-control" v-model.number="newBook.costPrice">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">初始库存</label>
                                <input type="number" class="form-control" v-model.number="newBook.stock">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">报警阈值 (Min_Stock)</label>
                                <input type="number" class="form-control" v-model.number="newBook.minStock" value="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">供应商</label>
                            <input type="text" class="form-control" v-model="newBook.supplier" placeholder="出版社或代理商名称">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveNewBook">保存并入库</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'inventory',
                searchQuery: '',
                // 模拟财务数据
                stats: {
                    dailySales: 12580.00,
                    dailyProfit: 3420.00
                },
                // 模拟图书数据：增加了 costPrice (进价) 和 supplier (供应商) - 对应 Admin View
                books: [
                    { 
                        isbn: '9787506365437', title: '活着', 
                        costPrice: 20.00, price: 35.00, 
                        stock: 7, minStock: 10, supplier: '新华书店总仓' 
                    },
                    { 
                        isbn: '9787111545682', title: '深入理解计算机系统', 
                        costPrice: 80.00, price: 139.00, 
                        stock: 50, minStock: 10, supplier: '机械工业出版社' 
                    },
                    { 
                        isbn: '9787302423287', title: '数据结构', 
                        costPrice: 30.00, price: 58.00, 
                        stock: 100, minStock: 20, supplier: '清华社直供' 
                    }
                ],
                // 模拟缺货表 T_SHORTAGE
                shortages: [
                    { id: 101, bookName: '活着', source: 'Auto', qty: 15, costPerUnit: 20.00 }
                ],
                // 模拟订单表 T_ORDERS
                orders: [
                    { id: 2023001, customerName: "李四", date: "2023-10-25 14:30", amount: 128.50, status: 'Paid' },
                    { id: 2023002, customerName: "王五", date: "2023-10-26 09:15", amount: 45.00, status: 'Pending' },
                    { id: 2023003, customerName: "张三", date: "2023-10-24 18:20", amount: 256.00, status: 'Shipped' },
                ],
                // 新书录入表单数据
                newBookModal: null,
                newBook: { isbn: '', title: '', price: 0, costPrice: 0, stock: 100, minStock: 10, supplier: '' }
            }
        },
        computed: {
            filteredBooks() {
                if (!this.searchQuery) return this.books;
                const query = this.searchQuery.toLowerCase();
                return this.books.filter(b => b.title.toLowerCase().includes(query) || b.isbn.includes(query));
            }
        },
        mounted() {
            this.newBookModal = new bootstrap.Modal(document.getElementById('newBookModal'));
        },
        methods: {
            // 打开新书录入弹窗
            openNewBookModal() {
                this.newBook = { isbn: '', title: '', price: 0, costPrice: 0, stock: 100, minStock: 10, supplier: '' };
                this.newBookModal.show();
            },
            // 保存新书
            /*saveNewBook() {
                if(!this.newBook.isbn || !this.newBook.title) {
                    alert("ISBN和书名不能为空！");
                    return;
                }
                // 模拟后端插入：将新书数据 push 到前端数组
                this.books.push({ ...this.newBook });
                
                alert(`新书《${this.newBook.title}》已成功录入数据库！\n同时在 T_BOOK_SUPPLIER 建立了关联关系。`);
                this.newBookModal.hide();
            },*/
    <!-- 新书录入表单提交处理函数 -->
            saveNewBook() {
                if(!this.newBook.isbn || !this.newBook.title) {
                    alert("ISBN和书名不能为空！");
                    return;
                }

                // 发送真实请求到后端
                axios.post('http://localhost:8080/api/admin/books', this.newBook)
                    .then(res => {
                        if (res.data.success) {
                            alert("录入成功！");
                            this.newBookModal.hide();

                            // !关键修复：录入成功后，必须重新从数据库拉取列表！
                            // 之前代码是 this.books.push(...)，这只是改了内存，一刷新就没了。
                            // 现在我们重新调用 fetchBooks()
                            this.fetchBooks();
                        } else {
                            alert("录入失败: " + res.data.message);
                        }
                    })
                    .catch(err => alert("网络错误"));
            },

            // 确保你有这个方法用于刷新数据
            fetchBooks() {
                axios.get('http://localhost:8080/api/admin/books')
                    .then(res => {
                        this.books = res.data;
                    });
            },

            // 处理补货逻辑
            handleRestock(item) {
                if(confirm(`确认向 [${item.bookName}] 的供应商发起采购？\n预计成本: ¥${(item.qty * item.costPerUnit).toFixed(2)}`)) {
                    // 模拟后端：更新库存并删除缺货记录
                    alert("采购单已发送，系统将自动触发 TR_Restock_Clear_Shortage 更新库存。");
                    this.shortages = this.shortages.filter(s => s.id !== item.id);
                    // 同时更新一下前端显示的库存（仅演示用）
                    const book = this.books.find(b => b.title === item.bookName);
                    if(book) book.stock += item.qty;
                }
            },
            // 获取订单状态样式
            getOrderStatusClass(status) {
                if (status === 'Paid') return 'bg-success';
                if (status === 'Pending') return 'bg-warning text-dark';
                if (status === 'Shipped') return 'bg-primary';
                return 'bg-secondary';
            },
            // 发货逻辑
            shipOrder(order) {
                if(confirm(`确认要为订单 #${order.id} 发货吗？`)) {
                    order.status = 'Shipped';
                    alert("发货成功！库存已扣减。");
                }
            },
            refreshData() {
                alert("数据已刷新");
            }
        }
    }).mount('#adminApp');
</script>

</body>
</html>