<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>网上书店 - 企业级后台管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* 侧边栏样式 */
    .sidebar { background: #2c3e50; min-height: 100vh; color: #ecf0f1; }
    .nav-link { color: #bdc3c7; cursor: pointer; transition: 0.3s; }
    .nav-link:hover { color: #fff; background: #3e5871; }
    .nav-link.active { background: #3498db; color: #fff; border-left: 4px solid #fff; }

    /* 统计卡片样式 */
    .card-stat { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

    /* 价格颜色 */
    .text-price { color: #e74c3c; font-weight: bold; } /* 进价红 */
    .text-profit { color: #27ae60; font-weight: bold; } /* 利润绿 */
  </style>
</head>
<body>

<div id="adminApp">

  <div v-if="!isLoggedIn" class="d-flex justify-content-center align-items-center vh-100 bg-dark">
    <div class="card p-4 shadow-lg" style="width: 400px;">
      <div class="text-center mb-4">
        <i class="fas fa-user-shield fa-3x text-primary mb-3"></i>
        <h4>后台管理系统</h4>
        <p class="text-muted small">仅限授权人员访问 (Online BookStore)</p>
      </div>
      <form @submit.prevent="handleLogin">
        <div class="mb-3">
          <label class="form-label">管理员账号</label>
          <input type="text" class="form-control" v-model="loginForm.username" placeholder="请输入管理员账号">
        </div>
        <div class="mb-3">
          <label class="form-label">密码</label>
          <input type="password" class="form-control" v-model="loginForm.password" placeholder="请输入密码">
        </div>
        <button type="submit" class="btn btn-primary w-100">安全登录</button>
      </form>
    </div>
  </div>

  <div v-else class="d-flex">

    <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 250px;">
      <h4 class="text-center mb-4"><i class="fas fa-database me-2"></i>后台管理</h4>

      <div class="user-panel mb-3 text-center pb-3 border-bottom border-secondary">
        <div class="bg-light rounded-circle mx-auto d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px; color: #333;">
          <i class="fas fa-user-tie fa-lg"></i>
        </div>
        <div class="small">Admin: <strong>{{ adminUser.username }}</strong></div>
        <div class="badge bg-danger mt-1">{{ adminUser.role }}</div>
        <button class="btn btn-outline-light btn-sm mt-3 w-75" @click="handleLogout">
          <i class="fas fa-sign-out-alt"></i> 退出登录
        </button>
      </div>

      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item mb-2">
          <a class="nav-link" :class="{active: currentTab === 'dashboard'}" @click="currentTab = 'dashboard'">
            <i class="fas fa-chart-line me-2"></i> 财务概览
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'">
            <i class="fas fa-boxes me-2"></i> 库存与成本
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link" :class="{active: currentTab === 'procurement'}" @click="currentTab = 'procurement'">
            <i class="fas fa-truck me-2"></i> 采购监控
            <span v-if="shortages.length" class="badge bg-warning text-dark float-end">{{shortages.length}}</span>
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link" :class="{active: currentTab === 'orders'}" @click="currentTab = 'orders'">
            <i class="fas fa-file-invoice-dollar me-2"></i> 订单发货
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" :class="{active: currentTab === 'customers'}" @click="currentTab = 'customers'">
            <i class="fas fa-users me-2"></i> 客户管理
          </a>
        </li>
      </ul>
    </div>

    <div class="flex-grow-1 bg-light p-4 overflow-auto" style="height: 100vh;">

      <div v-if="currentTab === 'dashboard'">
        <h3 class="mb-4">财务经营数据</h3>
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="card card-stat p-3 bg-white">
              <div class="text-muted small">总销售额 (Revenue)</div>
              <div class="fs-3 fw-bold text-primary">¥{{ stats.dailySales.toFixed(2) }}</div>
              <small class="text-muted">基于视图 V_SALES_REPORT</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-stat p-3 bg-white">
              <div class="text-muted small">估算毛利 (Profit)</div>
              <div class="fs-3 fw-bold text-success">¥{{ stats.dailyProfit.toFixed(2) }}</div>
              <small class="text-muted">按 40% 利润率估算</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-stat p-3 bg-white">
              <div class="text-muted small">待发货订单</div>
              <div class="fs-3 fw-bold text-warning">{{ orders.filter(o => o.status === 'Paid').length }} 单</div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentTab === 'inventory'">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>库存与成本 (Admin View)</h3>
          <div>
            <button class="btn btn-danger me-2" @click="batchClearStock" :disabled="selectedBooks.length === 0">
              <i class="fas fa-trash-alt"></i> 清空选中库存
            </button>
            <button class="btn btn-primary" @click="openNewBookModal">
              <i class="fas fa-plus"></i> 新书录入
            </button>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
              <tr>
                <th style="width: 40px;" class="text-center">
                  <input type="checkbox" class="form-check-input" v-model="selectAll" @change="toggleSelectAll">
                </th>
                <th>ISBN / 书名</th>
                <th>供应商</th>
                <th>进价 (Cost)</th>
                <th>售价 (Price)</th>
                <th>库存 / 警戒线</th>
                <th>状态</th>
              </tr>
              </thead>
              <tbody>
              <tr v-for="book in filteredBooks" :key="book.isbn">
                <td class="text-center">
                  <input type="checkbox" class="form-check-input" :value="book.isbn" v-model="selectedBooks">
                </td>
                <td>
                  <div class="fw-bold">{{ book.title }}</div>
                  <div class="text-muted small">{{ book.isbn }}</div>
                </td>
                <td>{{ book.supplier || '默认供应商' }}</td>
                <td class="text-price">¥{{ book.costPrice ? book.costPrice.toFixed(2) : '0.00' }}</td>
                <td>¥{{ book.price.toFixed(2) }}</td>
                <td>
                                        <span :class="book.stockQty < book.minStock ? 'text-danger fw-bold' : ''">
                                            {{ book.stockQty }} / {{ book.minStock }}
                                        </span>
                </td>
                <td>
                  <span v-if="book.stockQty < book.minStock" class="badge bg-danger">缺货</span>
                  <span v-else class="badge bg-success">充足</span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div v-if="currentTab === 'procurement'">
        <h3 class="mb-4">智能采购监控</h3>
        <div class="alert alert-info shadow-sm">
          <i class="fas fa-robot me-2"></i> 数据来源：数据库视图 <strong>V_PURCHASE_GUIDE</strong> (自动关联缺货记录与供应商)
        </div>
        <div class="card shadow-sm border-0">
          <table class="table table-striped mb-0">
            <thead class="bg-light">
            <tr>
              <th>记录ID</th>
              <th>缺货图书</th>
              <th>建议补货量</th>
              <th>供应商联系方式</th>
              <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="s in shortages" :key="s.RecordID">
              <td>#{{ s.RecordID }}</td>
              <td>
                <strong>{{ s.Title }}</strong><br>
                <small>{{ s.ISBN }}</small>
              </td>
              <td class="fw-bold fs-5 text-danger">{{ s.Need_Qty }}</td>
              <td>{{ s.Supplier_Info }}</td>
              <td>
                <button class="btn btn-success btn-sm" @click="handleRestock(s)">
                  <i class="fas fa-check-circle me-1"></i> 确认进货
                </button>
              </td>
            </tr>
            <tr v-if="shortages.length === 0">
              <td colspan="5" class="text-center py-5 text-muted">
                <i class="fas fa-check-circle fa-2x mb-3 text-success"></i><br>
                当前库存充足，无缺货记录。
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div v-if="currentTab === 'orders'">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>订单发货管理</h3>
          <button class="btn btn-outline-secondary btn-sm" @click="fetchAllData">
            <i class="fas fa-sync"></i> 刷新列表
          </button>
        </div>
        <div class="card shadow-sm border-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th>订单号</th>
              <th>客户名</th>
              <th>下单时间</th>
              <th>金额</th>
              <th>当前状态</th>
              <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="order in orders" :key="order.id">
              <td>#{{ order.id }}</td>
              <td>{{ order.customerName }}</td>
              <td>{{ new Date(order.date).toLocaleString() }}</td>
              <td class="fw-bold">¥{{ order.amount.toFixed(2) }}</td>
              <td>
                <span class="badge" :class="getStatusClass(order.status)">{{ order.status }}</span>
              </td>
              <td>
                <button v-if="order.status === 'Paid'" class="btn btn-primary btn-sm" @click="shipOrder(order)">
                  <i class="fas fa-shipping-fast"></i> 发货
                </button>
                <button v-else-if="order.status === 'Shipped'" class="btn btn-success btn-sm" disabled>
                  <i class="fas fa-check"></i> 已发货
                </button>
                <button v-else class="btn btn-secondary btn-sm" disabled>
                  <i class="fas fa-clock"></i> 等待付款
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div v-if="currentTab === 'customers'">
        <h3 class="mb-4">注册客户列表</h3>
        <div class="card shadow-sm border-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>用户名</th>
              <th>地址</th>
              <th>余额</th>
              <th>累计消费</th>
              <th>信用等级</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="c in customers" :key="c.customerId">
              <td>#{{ c.customerId }}</td>
              <td>
                <div class="fw-bold">{{ c.name }}</div>
              </td>
              <td class="text-muted small">{{ c.address }}</td>
              <td class="fw-bold text-success">¥{{ c.balance.toFixed(2) }}</td>
              <td>¥{{ c.totalSpent.toFixed(2) }}</td>
              <td>
                                    <span class="badge"
                                          :class="c.creditLevel >= 4 ? 'bg-warning text-dark' : (c.creditLevel >= 2 ? 'bg-info text-dark' : 'bg-secondary')">
                                        LV.{{ c.creditLevel }}
                                    </span>
              </td>
            </tr>
            <tr v-if="customers.length === 0">
              <td colspan="6" class="text-center py-4 text-muted">暂无注册用户</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div> </div> <div class="modal fade" id="newBookModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新书录入系统</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ISBN <span class="text-danger">*</span></label>
              <input type="text" class="form-control" v-model="newBook.isbn" placeholder="13位纯数字，无横杠">
            </div>
            <div class="col-md-6">
              <label class="form-label">书名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" v-model="newBook.title">
            </div>

            <div class="col-md-6">
              <label class="form-label">作者</label>
              <input type="text" class="form-control" v-model="newBook.authorName" placeholder="例如: 余华, 莫言">
            </div>
            <div class="col-md-6">
              <label class="form-label">出版社</label>
              <input type="text" class="form-control" v-model="newBook.publisher">
            </div>

            <div class="col-md-6">
              <label class="form-label">销售价 (Price)</label>
              <div class="input-group">
                <span class="input-group-text">¥</span>
                <input type="number" class="form-control" v-model.number="newBook.price">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">供应商 <span class="text-danger">*</span></label>
              <select class="form-select" v-model="newBook.supplierId">
                <option disabled value="">-- 请选择 --</option>
                <option v-for="sup in suppliers" :value="sup.supplierId">
                  {{ sup.name }}
                </option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">初始库存</label>
              <input type="number" class="form-control" v-model.number="newBook.stockQty">
            </div>
            <div class="col-md-6">
              <label class="form-label">最低警戒线</label>
              <input type="number" class="form-control" v-model.number="newBook.minStock">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" @click="saveNewBook">保存并入库</button>
      </div>
    </div>
  </div>
</div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  const { createApp } = Vue;
  // 确保与后端端口一致
  const API_BASE = 'http://localhost:8080/api';
  // 允许 Axios 携带 Cookie (用于管理员登录状态)
  axios.defaults.withCredentials = true;

  createApp({
    data() {
      return {
        // 状态管理
        isLoggedIn: false,
        loginForm: { username: '', password: '' },
        adminUser: { username: '', role: '' },

        // 页面数据
        currentTab: 'inventory',
        searchQuery: '',
        newBookModal: null,

        // 核心数据源 (从后端拉取)
        books: [],
        shortages: [],
        orders: [],
        suppliers: [],
        customers: [], // 新增客户列表
        stats: { dailySales: 0, dailyProfit: 0 },

        // 批量操作
        selectedBooks: [],
        selectAll: false,

        // 新书表单
        newBook: {
          isbn: '', title: '', authorName: '', publisher: '',
          price: 0, supplierId: '', stockQty: 100, minStock: 10
        }
      }
    },
    computed: {
      filteredBooks() {
        if (!this.searchQuery) return this.books;
        const query = this.searchQuery.toLowerCase();
        if (!this.books) return [];
        return this.books.filter(b =>
                (b.title && b.title.toLowerCase().includes(query)) ||
                (b.isbn && b.isbn.includes(query))
        );
      }
    },
    mounted() {
      // 初始化 Modal
      this.newBookModal = new bootstrap.Modal(document.getElementById('newBookModal'));

      // 页面加载时检查 Session/Cookie 状态
      this.checkAdminSession();
    },
    methods: {
      // ------------------ 登录状态检查 ------------------
      checkAdminSession() {
        // 尝试调用后端检查接口
        axios.get(`${API_BASE}/admin/check-login`)
                .then(res => {
                  if(res.data.success) {
                    this.isLoggedIn = true;
                    this.adminUser = res.data.data;
                    this.fetchAllData();
                    this.fetchSuppliers();
                  } else {
                    this.isLoggedIn = false;
                  }
                })
                .catch(() => {
                  this.isLoggedIn = false;
                });
      },

      // ------------------ 登录/退出 ------------------
      handleLogin() {
        if(!this.loginForm.username || !this.loginForm.password) {
          alert("请输入账号密码"); return;
        }
        axios.post(`${API_BASE}/admin/login`, this.loginForm)
                .then(res => {
                  if(res.data.success) {
                    this.isLoggedIn = true;
                    this.adminUser = { username: this.loginForm.username, role: res.data.role };
                    // 登录成功后，才去拉取数据
                    this.fetchAllData();
                    this.fetchSuppliers();
                  } else {
                    alert(res.data.message);
                  }
                });
      },
      handleLogout() {
        axios.post(`${API_BASE}/admin/logout`).then(() => {
          this.isLoggedIn = false;
          this.books = []; // 清空敏感数据
          this.customers = [];
          this.loginForm = { username: '', password: '' };
        });
      },

      // ------------------ 数据获取 ------------------
      fetchAllData() {
        axios.get(`${API_BASE}/admin/books`).then(res => this.books = res.data);
        axios.get(`${API_BASE}/shortages`).then(res => this.shortages = res.data);
        axios.get(`${API_BASE}/admin/orders`).then(res => this.orders = res.data);
        axios.get(`${API_BASE}/admin/stats`).then(res => this.stats = res.data);
        // 拉取客户数据
        axios.get(`${API_BASE}/admin/customers`).then(res => this.customers = res.data);
      },
      fetchSuppliers() {
        axios.get(`${API_BASE}/suppliers`).then(res => {
          this.suppliers = res.data;
          // 默认选中第一个，防止下拉框为空
          if(this.suppliers.length > 0) this.newBook.supplierId = this.suppliers[0].supplierId;
        });
      },

      // ------------------ 新书录入 ------------------
      openNewBookModal() {
        // 重置表单
        this.newBook = {
          isbn: '', title: '', authorName: '', publisher: '', price: 0,
          supplierId: this.suppliers.length > 0 ? this.suppliers[0].supplierId : '',
          stockQty: 100, minStock: 10
        };
        this.newBookModal.show();
      },
      saveNewBook() {
        if(!this.newBook.isbn || !this.newBook.title) {
          alert("ISBN和书名不能为空"); return;
        }
        axios.post(`${API_BASE}/admin/books`, this.newBook).then(res => {
          if(res.data.success) {
            alert("录入成功！");
            this.newBookModal.hide();
            this.fetchAllData(); // 刷新列表
          } else {
            alert("失败: " + res.data.message);
          }
        });
      },

      // ------------------ 库存管理 ------------------
      toggleSelectAll() {
        this.selectedBooks = this.selectAll ? this.books.map(b => b.isbn) : [];
      },
      batchClearStock() {
        if(confirm(`确定要清空 ${this.selectedBooks.length} 本书的库存吗？\n这将触发布发器生成缺货报警！`)) {
          axios.post(`${API_BASE}/admin/books/clear`, { isbns: this.selectedBooks })
                  .then(res => {
                    if(res.data.success) {
                      alert("操作成功");
                      this.selectedBooks = [];
                      this.selectAll = false;
                      this.fetchAllData();
                    } else {
                      alert("失败: " + res.data.message);
                    }
                  });
        }
      },

      // ------------------ 采购与订单 ------------------
      handleRestock(item) {
        // 兼容不同命名
        const isbn = item.ISBN || item.isbn;
        const qty = item.Need_Qty || item.needQty || item.quantity;
        if(confirm(`确认向供应商发起采购？\n数量: ${qty}`)) {
          axios.post(`${API_BASE}/shortages/restock`, { isbn: isbn, qty: qty }).then(res => {
            alert(res.data.message);
            this.fetchAllData(); // 补货后刷新
          });
        }
      },
      shipOrder(order) {
        axios.post(`${API_BASE}/orders/ship`, { id: order.id }).then(res => {
          alert("发货成功");
          this.fetchAllData();
        });
      },
      getStatusClass(s) {
        return s === 'Paid' ? 'bg-success' : (s === 'Shipped' ? 'bg-primary' : 'bg-secondary');
      }
    }
  }).mount('#adminApp');
</script>
</body>
</html>